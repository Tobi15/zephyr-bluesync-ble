<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluesync in BLE Mesh: Conception of BlueSync in Zephyr RTOS</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Bluesync in BLE Mesh<span id="projectnumber">&#160;1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Conception of BlueSync in Zephyr RTOS</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The design of BlueSync in Zephyr RTOS was driven by the need for an efficient, scalable, and accurate time synchronization protocol tailored to the constraints of BLE Mesh in linear sensor deployments (e.g., tunnels).</p>
<h1>Objectives</h1>
<ul>
<li>Achieve <b>microsecond-level</b> synchronization accuracy over BLE Mesh.</li>
<li>Support <b>low-power, resource-constrained</b> devices.</li>
<li>Use <b>BLE Extended Advertising</b> for long-range, non-connectable broadcasts.</li>
<li>Enable <b>multi-hop time propagation</b> across a linear network.</li>
<li>Integrate seamlessly with <b>Zephyr RTOS modules</b> and drivers.</li>
</ul>
<h1>Key Design Principles</h1>
<ul>
<li><b>Centralized Authority Node</b> <br  />
 A gateway node with NTP or GPS access serves as the synchronization anchor.</li>
<li><b>One-Way Sync</b> <br  />
 Clients passively receive extended advertisements carrying timestamps.</li>
<li><b>Precise Hardware Timestamping</b> <br  />
 Clients use hardware timers (e.g., RTC, TIMER2) to timestamp sync packet arrival.</li>
<li><b>Linear Regression Drift Correction</b> <br  />
 Clock offset and drift are estimated using linear regression over multiple timestamp pairs.</li>
<li><b>Chained Multi-Hop Propagation</b> <br  />
 Downstream nodes receive re-broadcasted sync packets and synchronize in turn.</li>
</ul>
<h1>BlueSync Packet Format</h1>
<p><img src="images/packet_format.png" alt="Packet Format" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Size   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>round_id</code>   </td><td class="markdownTableBodyNone">1 byte   </td><td class="markdownTableBodyNone">ID for the sync round, incremented by Authority    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>slot_idx</code>   </td><td class="markdownTableBodyNone">1 byte   </td><td class="markdownTableBodyNone">Optional slot index (can be used for future use)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>timestamp</code>   </td><td class="markdownTableBodyNone">8 bytes   </td><td class="markdownTableBodyNone">Master time in microseconds (Unix epoch)   </td></tr>
</table>
<h1>State Machine Overview</h1>
<p><img src="images/state_machine_bluesync.png" alt="State Machine" class="inline"/></p>
<h2>Authority Node (Gateway)</h2>
<ul>
<li><code>STOP</code>: Initial idle state.</li>
<li><code>ADV</code>: Starts a sync round, increments <code>round_id</code>, advertises a burst of sync packets, returns to <code>STOP</code>.</li>
</ul>
<h2>Client Node (Sensor)</h2>
<ul>
<li><code>SCAN_WAIT_FOR_SYNC</code>: Listens for sync packets.</li>
<li><code>SYNC</code>: Collects timestamp pairs.</li>
<li><code>UPDATE</code>: Computes and applies clock correction using regression.</li>
<li><code>ADV</code>: Optionally rebroadcasts sync packet; returns to <code>SCAN_WAIT_FOR_SYNC</code>.</li>
</ul>
<h1>Synchronization Flow</h1>
<ol type="1">
<li>Authority broadcasts sync message with timestamp.</li>
<li>Clients timestamp the reception and store local/master pairs.</li>
<li>After receiving N messages, clients estimate slope and offset.</li>
<li>Logical time is corrected using: <div class="fragment"><div class="line">logical_time(t) = slope * local_time(t) + offset</div>
</div><!-- fragment --></li>
<li>Clients forward sync message to downstream nodes.</li>
<li>The process repeats down the linear topology.</li>
</ol>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
